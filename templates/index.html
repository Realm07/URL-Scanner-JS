<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AST Vulnerability Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { height: 100vh; background-color: #1e1e1e; border-right: 1px solid #333; padding: 20px; overflow-y: auto; }
        .main-content { height: 100vh; overflow-y: auto; padding: 30px; }
        .card { background-color: #2d2d2d; border: 1px solid #444; color: #fff; margin-bottom: 20px; }
        .form-control, .form-select { background-color: #333; border: 1px solid #555; color: #fff; }
        .form-control:focus { background-color: #444; color: #fff; border-color: #0d6efd; }
        .log-window { background-color: #000; color: #00ff00; font-family: 'Courier New', monospace; height: 400px; overflow-y: scroll; padding: 15px; border-radius: 5px; border: 1px solid #333; white-space: pre-wrap; font-size: 0.9em; }
        .nav-tabs .nav-link { color: #aaa; }
        .nav-tabs .nav-link.active { background-color: #2d2d2d; color: #fff; border-color: #444 #444 #2d2d2d; }
        .history-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s; }
        .history-item:hover { background-color: #333; }
        iframe { width: 100%; height: 800px; border: none; background: white; border-radius: 5px; }
        .badge-port { background: #0d6efd; font-size: 0.8em; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar: History -->
        <div class="col-md-3 sidebar">
            <h4 class="mb-4">Scan History</h4>
            <div id="history-list">
                {% for item in history %}
                <div class="history-item" onclick="loadReport('{{ item.name }}')">
                    <div><strong>{{ item.name.split('_')[0] }}</strong> 
                        {% if '_' in item.name %}
                        <span class="badge-port">{{ item.name.split('_')[1] }}</span>
                        {% endif %}
                    </div>
                    {% if item.has_report %}
                    <small class="text-success">Report Available</small>
                    {% else %}
                    <small class="text-muted">No Report</small>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 main-content">
            <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="scan-tab" data-bs-toggle="tab" data-bs-target="#scan" type="button">New Scan</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button">Live Logs</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button">Settings</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" type="button">View Report</button>
                </li>
            </ul>

            <div class="tab-content" id="myTabContent">
                
                <!-- Scan Tab -->
                <div class="tab-pane fade show active" id="scan">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Configure Scan</h5>
                            <div class="mb-3">
                                <label class="form-label">Target URL</label>
                                <input type="text" class="form-control" id="urlInput" placeholder="http://localhost:3000" value="http://localhost:5174/">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Pages to Crawl</label>
                                <input type="number" class="form-control" id="maxPages" value="15">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Google API Key (Gemini)</label>
                                <input type="password" class="form-control" id="apiKey" placeholder="Leave empty to use environment variable">
                            </div>
                            <button class="btn btn-primary w-100" onclick="startScan()">Start Scan</button>
                        </div>
                    </div>
                </div>

                <!-- Logs Tab -->
                <div class="tab-pane fade" id="logs">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5>Scanner Output</h5>
                        <span id="statusBadge" class="badge bg-secondary">Idle</span>
                    </div>
                    <div class="log-window" id="logWindow">Waiting for scan to start...</div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Edit Config.yaml</h5>
                            <p class="text-muted small">Modify regex patterns and ignore lists here.</p>
                            <textarea class="form-control" id="configEditor" rows="20" style="font-family: monospace; background: #1e1e1e; color: #d4d4d4;">{{ config }}</textarea>
                            <button class="btn btn-success mt-3" onclick="saveConfig()">Save Configuration</button>
                        </div>
                    </div>
                </div>

                <!-- Report Tab -->
                <div class="tab-pane fade" id="report">
                    <div id="reportContainer">
                        <div class="alert alert-info">Select a scan from the history sidebar or run a new scan to see results here.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function startScan() {
        const url = document.getElementById('urlInput').value;
        const maxPages = document.getElementById('maxPages').value;
        const apiKey = document.getElementById('apiKey').value;

        if(!url) return alert("URL is required");

        // Switch to logs tab
        const triggerEl = document.querySelector('#logs-tab');
        const tab = new bootstrap.Tab(triggerEl);
        tab.show();

        document.getElementById('logWindow').innerHTML = "Initializing scan...\n";
        document.getElementById('statusBadge').className = "badge bg-warning";
        document.getElementById('statusBadge').innerText = "Running";

        // Start Scan via API
        fetch('/start_scan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ url: url, max_pages: maxPages, api_key: apiKey })
        });

        // Connect to Log Stream
        const eventSource = new EventSource('/stream_logs');
        eventSource.onmessage = function(event) {
            const logWindow = document.getElementById('logWindow');
            logWindow.innerHTML += event.data + "\n";
            logWindow.scrollTop = logWindow.scrollHeight; // Auto scroll

            if (event.data.includes("[DONE]")) {
                eventSource.close();
                document.getElementById('statusBadge').className = "badge bg-success";
                document.getElementById('statusBadge').innerText = "Completed";
                alert("Scan Complete! Check the Reports tab.");
                location.reload(); // Reload to update sidebar
            }
        };
    }

    function loadReport(folderName) {
        const triggerEl = document.querySelector('#report-tab');
        const tab = new bootstrap.Tab(triggerEl);
        tab.show();

        const container = document.getElementById('reportContainer');
        container.innerHTML = `<iframe src="/view_report/${folderName}"></iframe>`;
    }

    function saveConfig() {
        const config = document.getElementById('configEditor').value;
        fetch('/save_settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ config: config })
        }).then(res => res.json()).then(data => {
            if(data.status === 'success') alert("Configuration Saved!");
            else alert("Error saving config: " + data.message);
        });
    }
</script>
</body>
</html>